#!/bin/zsh

if [[ "$#" != 1 ]]; then
    echo 1>&2 "usage: $0 HOST"
fi

SOCK_SSH=/tmp/ssh-$USER-$1
SOCK_DTACH=/tmp/dtach-$USER-$1
HOST=$1

if ! ssh -S $SOCK_SSH -O check $HOST 2>/dev/null; then
    dtach -n $SOCK_DTACH /usr/bin/ssh -NMS $SOCK_SSH $HOST
fi
/usr/bin/ssh -S $SOCK_SSH $HOST
